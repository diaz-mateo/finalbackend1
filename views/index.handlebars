<h1>🛍️ Productos</h1>

{{#if products.length}}
  <ul style="list-style: none; padding: 0;">
    {{#each products}}
      <li style="margin-bottom: 12px; border-bottom: 1px solid #ccc; padding: 8px 0;">
        <a href="/products/{{this._id}}" style="font-weight: bold; font-size: 1.1rem;">
          {{this.title}}
        </a> — ${{this.price}}

        {{#if this.stock}}
          <button 
            class="addToCartBtn"
            data-pid="{{this._id}}"
            style="margin-left: 12px;"
          >
            Agregar al carrito
          </button>
        {{else}}
          <span style="color: red; margin-left: 12px;">Sin stock</span>
        {{/if}}
      </li>
    {{/each}}
  </ul>
{{else}}
  <p>No hay productos disponibles.</p>
{{/if}}

<nav style="margin-top: 20px;">
  {{#if hasPrevPage}}
    <a href="?page={{prevPage}}&limit={{limit}}">« Anterior</a>
  {{/if}}

  <span style="margin: 0 12px;">Página {{page}} de {{totalPages}}</span>

  {{#if hasNextPage}}
    <a href="?page={{nextPage}}&limit={{limit}}">Siguiente »</a>
  {{/if}}
</nav>

<a href="/carts/{{cartId}}" style="display: block; margin-top: 30px;">🛒 Ver mi carrito</a>

<script>
  const cartId = '{{cartId}}';

  document.querySelectorAll('.addToCartBtn').forEach(button => {
    button.addEventListener('click', () => {
      const productId = button.dataset.pid;

      fetch(`/api/carts/${cartId}/products/${productId}`, {
        method: 'POST'
      })
      .then(res => {
        if (!res.ok) throw new Error('No se pudo agregar el producto');
        return res.json();
      })
      .then(() => {
        button.disabled = true;
        button.textContent = 'Agregado ✔️';
        setTimeout(() => {
          button.disabled = false;
          button.textContent = 'Agregar al carrito';
        }, 2000);
      })
      .catch(err => alert(err.message));
    });
  });
</script>